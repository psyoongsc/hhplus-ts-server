# STEP19 예상 병목 지점에 대한 부하 테스트 보고서

## 1. 대상 선정

e-Commerce 시스템에서 메인 로직으로 판단되는 상품 조회부터 결제까지의 API에 대해서 부하 테스트를 진행한다.

## 2. 목적

이 보고서는 실제 서비스 환경에서 발생할 수 있는 다양한 트래픽 상황에 대비하여 시스템의 안정성과 성능을 사전에 검증하고, 잠재적인 병목 지점과 장애 발생 가능성을 사전에 탐지하기 위한 목적을 가지고 있습니다.

주요 목적은 다음과 같습니다:

1. **예상 트래픽에 대한 시스템 처리 능력 평가**
    - 시나리오의 응답 시간, 처리량(TPS), 오류율을 측정하여 시스템의 성능 기준선을 도출합니다.
2. **고부하 상황에서의 병목 지점 탐색**
    - 부하 테스트를 통해 동시성 처리, DB 접근, 외부 시스템 연계 등에서 발생할 수 있는 처리 지연 및 자원 부족 문제를 식별합니다.
3. **장애 상황을 시뮬레이션하고 대응 전략 도출**
    - 테스트 결과를 기반으로 장애 발생 시의 탐지, 대응, 회복 프로세스를 구체화하고, 장애 대응 체계 수립을 위한 근거를 마련합니다.
4. **시스템 스펙 및 운영 정책에 대한 기준 설정**
    - 적절한 인프라 스펙, 캐시 전략, 트랜잭션 범위 조정, 비동기 처리를 위한 메시징 설계 등 향후 개선 방향에 대한 기초 자료로 활용합니다.
5. **관찰 가능성(Observability) 개선을 위한 피드백 확보**
    - Datadog, OpenSearch, Grafana 등 관측 도구에서 수집된 지표를 분석하여 모니터링 및 경고 체계를 고도화할 수 있는 인사이트를 도출합니다.

## 3. 성능 측정 방안

이번 부하 테스트에서는 **실제 운영 환경에 준하는 부하를 인위적으로 발생**시켜 시스템의 응답 성능과 안정성을 측정하고, 병목 지점을 사전에 식별하는 것을 목표로 합니다. 특히, **단시간 내 고강도 트래픽을 주입하는 Stress Test**를 통해 시스템의 최대 처리 능력을 평가합니다.

### 3-1. 테스트 도구 및 인프라 구성

| 구성 요소 | 설명 |
| --- | --- |
| **k6** | JavaScript 기반의 고성능 부하 테스트 도구. VU(Virtual Users)와 요청량을 정밀하게 제어 가능 |
| **Grafana + k6 Cloud** | 테스트 중 수집된 메트릭(응답시간, TPS, 오류율 등)을 실시간 대시보드로 시각화 |
| **Datadog/OpenSearch** | 로깅 및 트레이싱 시스템으로, 테스트 중 백엔드 시스템의 병목 원인 파악에 활용 가능 (옵션) |

### 3-2. 측정 지표 (Grafana Dashboard 기반)

테스트 결과는 k6와 연동된 Grafana 대시보드를 통해 실시간으로 시각화되며, 주요 성능 지표는 다음과 같습니다:

| 지표 | 의미 |
| --- | --- |
| **http_req_duration (mean/p95/p99)** | 요청 응답 시간의 평균 및 퍼센타일 지연율 |
| **Requests Per Second (RPS)** | 초당 처리 가능한 요청 수 |
| **Errors Per Second** | 시스템 처리 중 실패한 요청의 수 |
| **Checks** | 사용자 정의 조건에 따른 성공/실패 판별 지표 |
| **VU 상태 변화** | 시간별 가상 사용자 수의 변동 추이 |
| **Heatmap 시각화** | 응답 시간 구간별 분포를 색상으로 시각화해 지연 시간 집중 구간 식별 |

## 4. 시나리오

| 항목 | 내용 |
| --- | --- |
| **목표** | 짧은 시간 동안 최대 트래픽을 주입하여 병목 현상, 오류 발생 여부, 자원 한계 탐색 |
| **형태** | **Stress Test** - 빠른 속도로 가상 사용자 수를 최대치로 유지 |
| **시간** | 2분 |
| **VU 설정** | 100명 고정 (단일 시점에 많은 사용자가 몰리는 상황 가정) |
| **시나리오 흐름** | 상품 조회 → 주문 요청 (랜덤 상품) → 응답 기록 |

**Stress Test는 단기 고강도 부하에 대한 시스템 반응을 측정하는 데 적합**하며, 갑작스러운 트래픽 증가 시 서버의 응답 속도 및 오류율 변화를 집중적으로 분석합니다.

## 5. 실험
<img width="1602" alt="image" src="https://github.com/user-attachments/assets/08329934-b9cc-49a9-a7c7-7258939a9237" />

## 6. 실험 결과에 대한 분석

### 6-1. Virtual Users (VUs)

- 고정된 100명의 VU(가상 사용자)가 테스트 전 구간에 걸쳐 유지되고 있습니다.
- 이는 **constant VU 테스트 시나리오** (`vus: 100`, `duration: 2m`)일 가능성이 높습니다.
- 시스템은 테스트 내내 **지속적인 부하에 잘 반응하고 있는지**를 확인하는 구조입니다.

**📌 해석**:

- 서버가 갑작스럽게 과부하되거나 VU 증가에 따라 성능이 급격히 저하되지는 않았다는 점에서 **기본적인 안정성은 확보**된 것으로 보입니다.

### 6-2. 📈 Requests per Second (RPS)

- 평균: **160 RPS**
- 최대: **364 RPS**

초당 요청 수가 다소 **변동성이 큰 그래프**를 보이고 있으며, 특히 후반으로 갈수록 RPS의 **스파이크 현상**이 나타납니다. 이는 시스템의 응답 속도 변화나 일시적인 처리 지연에 따른 재시도 트래픽이 발생했을 가능성도 있습니다.

**📌 해석**:

- 평균적으로 160 RPS는 준수한 처리량이며, 최대값 364까지 도달한 것으로 보아 시스템은 **일정 수준의 부하 피크에도 대응 가능**합니다.
- 단, 스파이크 구간에서 latency와 연계하여 살펴보는 것이 중요합니다.

### 6-3. ⏱️ http_req_duration 분석

| 지표 | 값 | 해석 |
| --- | --- | --- |
| **평균 (mean)** | 620.71ms | 전체 응답 시간 평균 |
| **중앙값 (median)** | 571.69ms | 일반적인 사용자 응답 시간 |
| **최대 (max)** | 3.17s | 가장 느린 요청 (병목 가능성 있음) |
| **최소 (min)** | 55.30ms | 가장 빠른 요청 |
| **90th percentile (p90)** | 988.45ms | 90% 요청이 이보다 빠름 |
| **95th percentile (p95)** | 1.16s | 95% 요청이 이보다 빠름 |

**📌 해석**:

- 평균 응답 시간이 620ms는 실사용 환경에서는 수용 가능한 수준이지만,
- **p90, p95가 1초에 근접**하고, 최대 응답 시간이 3초를 넘는다는 것은 일부 요청에 대해 지연이 체감될 수 있음을 시사합니다.
- 이는 네트워크 지연, DB 처리 병목, GC pause, 컨테이너 리소스 부족 등 다양한 원인에 기인할 수 있습니다.

## 6. 결론

이번 부하 테스트는 e-Commerce 시스템의 주요 기능인 **상품 조회 및 주문 API**에 대해 **2분간의 고강도 Stress Test**를 수행하여, 서비스의 응답 성능과 병목 가능성을 점검하기 위한 목적으로 진행되었습니다. 테스트 결과, 시스템은 평균적으로 안정적인 처리 능력을 보였으나, **일부 고부하 구간에서의 성능 저하와 응답 지연 현상이 관측**되었습니다.

### 6-1. 주요 쟁점

- **고정된 100명의 Virtual Users를 유지하면서 평균 160 RPS, 최대 364 RPS까지 트래픽을 처리**하였고, 전체적으로 처리 실패 없이 안정적인 응답을 유지함.
- 그러나 `p90`, `p95`, `max latency` 등의 지표에서 **일부 요청이 1초 이상 지연**되는 현상이 발생하여 사용자 경험에 영향을 줄 수 있는 수준임.

### 6-2. 개선 방향 제안

- **p95 이상 응답 시간 지연 원인 파악**:
    - 문제 발생 시간대의 로그와 Trace 연계 분석 필요
    - NestJS의 `AsyncInterceptor`, `Logger`, `RequestLifecycleHooks` 등을 활용한 실행 시간 측정 도입
- **I/O 분산 처리 개선**:
    - Promise.all 적절한 병렬 처리 도입 여부 확인
    - Redis, DB 등 연동 지점에 대한 Circuit Breaker 또는 Timeout 설정 적용
- **DB 쿼리 최적화**:
    - 실행 계획(Explain) 분석 및 인덱싱 재검토
    - 트랜잭션 범위 최소화 및 응답용 DTO 경량화
- **NestJS 관찰 가능성 보강**:
    - Winston Logger 또는 Datadog APM 연동을 통한 응답 시간 모니터링
    - `@UseInterceptors(TimeoutInterceptor)`를 통한 응답 지연 감지 및 fallback 로직 적용

이번 테스트는 단기 고강도 부하에 대한 시스템의 기본 응답 성능을 확인하고, 향후 발생 가능한 **트래픽 급증·I/O 지연 상황에 대한 사전 대응 전략 수립의 근거**를 마련하였습니다. 실시간 관찰 도구와 로그 연계 분석 체계를 지속적으로 고도화함으로써, 장애 발생 가능성을 조기에 탐지하고 회복 가능한 서비스 구조를 설계해나가는 기반을 다졌습니다.
